<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <style>
        .hidden { display: none !important; }
        .chat-container { height: calc(100vh - 200px); }
        .messages-container { height: calc(100% - 60px); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-blue-600">Student Marketplace</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="browseBtn" class="nav-btn text-gray-700 hover:text-blue-600">Browse</button>
                    <button id="createListingBtn" class="nav-btn text-gray-700 hover:text-blue-600 hidden">Create Listing</button>
                    <button id="messagesBtn" class="nav-btn text-gray-700 hover:text-blue-600 hidden">Messages</button>
                    <button id="profileBtn" class="nav-btn text-gray-700 hover:text-blue-600 hidden">Profile</button>
                    <button id="logoutBtn" class="nav-btn text-red-600 hover:text-red-800 hidden">Logout</button>
                    <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Login</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Auth Screen -->
        <div id="authScreen" class="max-w-md mx-auto">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-center mb-6">Student Marketplace</h2>
                <p class="text-gray-600 text-center mb-6">Exclusive marketplace for University of Sussex and University of Brighton students</p>
                
                <!-- Login Form -->
                <div id="loginForm">
                    <h3 class="text-lg font-semibold mb-4">Login</h3>
                    <form id="loginFormElement">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">University Email</label>
                            <input type="email" id="loginEmail" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" placeholder="your.email@sussex.ac.uk or your.email@brighton.ac.uk" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                            <input type="password" id="loginPassword" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Login</button>
                    </form>
                    <p class="text-center mt-4">
                        Don't have an account? <button id="showRegisterBtn" class="text-blue-600 hover:underline">Register</button>
                    </p>
                </div>

                <!-- Register Form -->
                <div id="registerForm" class="hidden">
                    <h3 class="text-lg font-semibold mb-4">Register</h3>
                    <form id="registerFormElement">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">University Email</label>
                            <input type="email" id="registerEmail" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" placeholder="your.email@sussex.ac.uk or your.email@brighton.ac.uk" required>
                            <p class="text-sm text-gray-500 mt-1">Only @sussex.ac.uk and @brighton.ac.uk emails accepted</p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                            <input type="password" id="registerPassword" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Username</label>
                            <input type="text" id="registerUsername" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">University</label>
                            <select id="registerUniversity" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                                <option value="">Select University</option>
                                <option value="sussex">University of Sussex</option>
                                <option value="brighton">University of Brighton</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Register</button>
                    </form>
                    <p class="text-center mt-4">
                        Already have an account? <button id="showLoginBtn" class="text-blue-600 hover:underline">Login</button>
                    </p>
                </div>
            </div>
        </div>

        <!-- Browse Listings -->
        <div id="browseScreen" class="hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold mb-4">Browse Listings</h2>
                
                <!-- Search and Filters -->
                <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <input type="text" id="searchInput" placeholder="Search listings..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <select id="categoryFilter" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                                <option value="">All Categories</option>
                                <option value="sale">Items for Sale</option>
                                <option value="rent">Items for Rent</option>
                                <option value="service-offered">Services Offered</option>
                                <option value="service-wanted">Services Wanted</option>
                            </select>
                        </div>
                        <div>
                            <select id="locationFilter" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                                <option value="">All Locations</option>
                                <option value="brighton-city">Brighton City Center</option>
                                <option value="hove">Hove</option>
                                <option value="sussex-campus">Sussex Campus</option>
                                <option value="brighton-campus">Brighton Campus</option>
                                <option value="portslade">Portslade</option>
                                <option value="kemp-town">Kemp Town</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Listings Grid -->
                <div id="listingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Listings will be populated here -->
                </div>
            </div>
        </div>

        <!-- Create Listing -->
        <div id="createListingScreen" class="hidden">
            <div class="max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold mb-6">Create New Listing</h2>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <form id="createListingForm">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Category</label>
                            <select id="listingCategory" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                                <option value="">Select Category</option>
                                <option value="sale">Items for Sale</option>
                                <option value="rent">Items for Rent</option>
                                <option value="service-offered">Services Offered</option>
                                <option value="service-wanted">Services Wanted</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Title</label>
                            <input type="text" id="listingTitle" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Description</label>
                            <textarea id="listingDescription" rows="4" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Price (£)</label>
                            <input type="number" id="listingPrice" step="0.01" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Location</label>
                            <select id="listingLocation" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                                <option value="">Select Location</option>
                                <option value="brighton-city">Brighton City Center</option>
                                <option value="hove">Hove</option>
                                <option value="sussex-campus">Sussex Campus</option>
                                <option value="brighton-campus">Brighton Campus</option>
                                <option value="portslade">Portslade</option>
                                <option value="kemp-town">Kemp Town</option>
                            </select>
                        </div>
                        
                        <!-- Category-specific fields -->
                        <div id="categorySpecificFields"></div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Images</label>
                            <input type="file" id="listingImages" multiple accept="image/*" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                            <p class="text-sm text-gray-500 mt-1">Upload multiple images for your listing</p>
                        </div>
                        
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Create Listing</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messagesScreen" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 chat-container">
                <!-- Chat List -->
                <div class="lg:col-span-1">
                    <h2 class="text-2xl font-bold mb-4">Messages</h2>
                    <div class="bg-white rounded-lg shadow-md">
                        <div id="chatsList" class="divide-y">
                            <!-- Chat previews will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Chat Window -->
                <div class="lg:col-span-2">
                    <div id="chatWindow" class="bg-white rounded-lg shadow-md h-full hidden">
                        <div class="p-4 border-b">
                            <h3 id="chatTitle" class="font-semibold"></h3>
                            <p id="chatListingInfo" class="text-sm text-gray-600"></p>
                        </div>
                        <div id="messagesContainer" class="messages-container p-4 overflow-y-auto">
                            <!-- Messages will be populated here -->
                        </div>
                        <div class="p-4 border-t">
                            <div class="flex space-x-2">
                                <input type="text" id="messageInput" placeholder="Type a message..." class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                                <button id="sendMessageBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Send</button>
                            </div>
                        </div>
                    </div>
                    <div id="noChatSelected" class="bg-white rounded-lg shadow-md h-full flex items-center justify-center">
                        <p class="text-gray-500">Select a chat to start messaging</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile -->
        <div id="profileScreen" class="hidden">
            <div class="max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold mb-6">Profile</h2>
                
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <form id="profileForm">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Username</label>
                            <input type="text" id="profileUsername" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Real Name (Optional)</label>
                            <input type="text" id="profileRealName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Age (Optional)</label>
                            <input type="number" id="profileAge" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Location Area (Optional)</label>
                            <select id="profileLocation" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                                <option value="">Select Location</option>
                                <option value="brighton-city">Brighton City Center</option>
                                <option value="hove">Hove</option>
                                <option value="sussex-campus">Sussex Campus</option>
                                <option value="brighton-campus">Brighton Campus</option>
                                <option value="portslade">Portslade</option>
                                <option value="kemp-town">Kemp Town</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Bio (Optional)</label>
                            <textarea id="profileBio" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500"></textarea>
                        </div>
                        
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Update Profile</button>
                    </form>
                </div>
                
                <!-- My Listings -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">My Listings</h3>
                    <div id="myListings" class="space-y-4">
                        <!-- User's listings will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Listing Detail Modal -->
    <div id="listingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="modalTitle" class="text-2xl font-bold"></h2>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div id="modalContent">
                    <!-- Modal content will be populated here -->
                </div>
                
                <div class="mt-6 flex space-x-4">
                    <button id="contactSellerBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Contact Seller</button>
                    <button id="reportListingBtn" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-md w-full mx-4">
            <div class="p-6">
                <h3 class="text-lg font-semibold mb-4">Report Listing</h3>
                <form id="reportForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Reason</label>
                        <select id="reportReason" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                            <option value="">Select Reason</option>
                            <option value="spam">Spam</option>
                            <option value="inappropriate">Inappropriate Content</option>
                            <option value="fraud">Fraud/Scam</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Description</label>
                        <textarea id="reportDescription" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Screenshot (Optional)</label>
                        <input type="file" id="reportScreenshot" accept="image/*" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    
                    <div class="flex space-x-4">
                        <button type="submit" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">Submit Report</button>
                        <button type="button" id="cancelReport" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="firebase-config.js"></script>

    <script>

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Global variables
        let currentUser = null;
        let currentChatId = null;
        let listings = [];
        let chats = [];

        // DOM Elements
        const authScreen = document.getElementById('authScreen');
        const browseScreen = document.getElementById('browseScreen');
        const createListingScreen = document.getElementById('createListingScreen');
        const messagesScreen = document.getElementById('messagesScreen');
        const profileScreen = document.getElementById('profileScreen');

        // Navigation
        const navButtons = document.querySelectorAll('.nav-btn');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        // Auth state observer
        auth.onAuthStateChanged(async (user) => {
            if (user && user.emailVerified) {
                currentUser = user;
                await loadUserProfile();
                showAuthenticatedUI();
                showScreen('browse');
            } else {
                currentUser = null;
                showUnauthenticatedUI();
                showScreen('auth');
            }
        });

        // Show/hide UI elements based on auth state
        function showAuthenticatedUI() {
            document.getElementById('createListingBtn').classList.remove('hidden');
            document.getElementById('messagesBtn').classList.remove('hidden');
            document.getElementById('profileBtn').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            document.getElementById('loginBtn').classList.add('hidden');
        }

        function showUnauthenticatedUI() {
            document.getElementById('createListingBtn').classList.add('hidden');
            document.getElementById('messagesBtn').classList.add('hidden');
            document.getElementById('profileBtn').classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('loginBtn').classList.remove('hidden');
        }

        // Screen management
        function showScreen(screen) {
            const screens = [authScreen, browseScreen, createListingScreen, messagesScreen, profileScreen];
            screens.forEach(s => s.classList.add('hidden'));

            switch(screen) {
                case 'auth':
                    authScreen.classList.remove('hidden');
                    break;
                case 'browse':
                    browseScreen.classList.remove('hidden');
                    loadListings();
                    break;
                case 'create':
                    createListingScreen.classList.remove('hidden');
                    break;
                case 'messages':
                    messagesScreen.classList.remove('hidden');
                    loadChats();
                    break;
                case 'profile':
                    profileScreen.classList.remove('hidden');
                    loadMyListings();
                    break;
            }
        }

        // Navigation event listeners
        document.getElementById('browseBtn').addEventListener('click', () => showScreen('browse'));
        document.getElementById('createListingBtn').addEventListener('click', () => showScreen('create'));
        document.getElementById('messagesBtn').addEventListener('click', () => showScreen('messages'));
        document.getElementById('profileBtn').addEventListener('click', () => showScreen('profile'));
        document.getElementById('loginBtn').addEventListener('click', () => showScreen('auth'));

        // Auth form toggles
        document.getElementById('showRegisterBtn').addEventListener('click', () => {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        });

        document.getElementById('showLoginBtn').addEventListener('click', () => {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        });

        // Validate university email
        function validateUniversityEmail(email) {
            return email.endsWith('@sussex.ac.uk') || email.endsWith('@brighton.ac.uk');
        }

        // Register form submission
        document.getElementById('registerFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const username = document.getElementById('registerUsername').value;
            const university = document.getElementById('registerUniversity').value;

            if (!validateUniversityEmail(email)) {
                alert('Please use a valid university email address');
                return;
            }

            try {
                const result = await auth.createUserWithEmailAndPassword(email, password);
                await result.user.sendEmailVerification();
                
                // Create user profile
                await db.collection('users').doc(result.user.uid).set({
                    email,
                    username,
                    university,
                    emailVerified: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Registration successful! Please check your email to verify your account.');
            } catch (error) {
                alert('Registration failed: ' + error.message);
            }
        });

        // Login form submission
        document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await auth.signOut();
            } catch (error) {
                alert('Logout failed: ' + error.message);
            }
        });

        // Load user profile
        async function loadUserProfile() {
            if (!currentUser) return;
            
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (doc.exists) {
                    const userData = doc.data();
                    document.getElementById('profileUsername').value = userData.username || '';
                    document.getElementById('profileRealName').value = userData.realName || '';
                    document.getElementById('profileAge').value = userData.age || '';
                    document.getElementById('profileLocation').value = userData.location || '';
                    document.getElementById('profileBio').value = userData.bio || '';
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Profile form submission
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) return;

            const profileData = {
                username: document.getElementById('profileUsername').value,
                realName: document.getElementById('profileRealName').value,
                age: document.getElementById('profileAge').value ? parseInt(document.getElementById('profileAge').value) : null,
                location: document.getElementById('profileLocation').value,
                bio: document.getElementById('profileBio').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('users').doc(currentUser.uid).update(profileData);
                alert('Profile updated successfully!');
            } catch (error) {
                alert('Failed to update profile: ' + error.message);
            }
        });

        // Category-specific fields
        document.getElementById('listingCategory').addEventListener('change', (e) => {
            const category = e.target.value;
            const fieldsContainer = document.getElementById('categorySpecificFields');
            fieldsContainer.innerHTML = '';

            if (category === 'sale' || category === 'rent') {
                fieldsContainer.innerHTML = `
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Time Available</label>
                        <input type="text" id="timeAvailable" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" placeholder="e.g., Weekdays 9-5">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Delivery Options</label>
                        <select id="deliveryOptions" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                            <option value="pickup">Pickup Only</option>
                            <option value="delivery">Delivery Available</option>
                            <option value="both">Both</option>
                        </select>
                    </div>
                    ${category === 'rent' ? `
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Rent Duration</label>
                        <input type="text" id="rentDuration" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" placeholder="e.g., Per day, Per week">
                    </div>` : ''}
                `;
            } else if (category === 'service-offered' || category === 'service-wanted') {
                fieldsContainer.innerHTML = `
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">${category === 'service-offered' ? 'When Available' : 'When Needed'}</label>
                        <input type="text" id="serviceTime" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" placeholder="e.g., Weekends, Flexible">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Estimated Time</label>
                        <input type="text" id="estimatedTime" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" placeholder="e.g., 2 hours, Half day">
                    </div>
                `;
            }
        });

        // Create listing form submission
        document.getElementById('createListingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser) return;

            // Check user's listing count
            const userListings = await db.collection('listings').where('userId', '==', currentUser.uid).get();
            if (userListings.size >= 30) {
                alert('Maximum of 30 listings allowed per user');
                return;
            }

            const listingData = {
                userId: currentUser.uid,
                category: document.getElementById('listingCategory').value,
                title: document.getElementById('listingTitle').value,
                description: document.getElementById('listingDescription').value,
                price: parseFloat(document.getElementById('listingPrice').value),
                location: document.getElementById('listingLocation').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                active: true
            };

            // Add category-specific fields
            const category = listingData.category;
            if (category === 'sale' || category === 'rent') {
                listingData.timeAvailable = document.getElementById('timeAvailable')?.value || '';
                listingData.deliveryOptions = document.getElementById('deliveryOptions')?.value || '';
                if (category === 'rent') {
                    listingData.rentDuration = document.getElementById('rentDuration')?.value || '';
                }
            } else if (category === 'service-offered' || category === 'service-wanted') {
                listingData.serviceTime = document.getElementById('serviceTime')?.value || '';
                listingData.estimatedTime = document.getElementById('estimatedTime')?.value || '';
            }

            try {
                // Handle image uploads
                const images = document.getElementById('listingImages').files;
                const imageUrls = [];
                
                for (let i = 0; i < images.length; i++) {
                    const image = images[i];
                    const imageRef = storage.ref(`listings/${currentUser.uid}/${Date.now()}_${image.name}`);
                    const snapshot = await imageRef.put(image);
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    imageUrls.push(downloadURL);
                }
                
                listingData.images = imageUrls;

                await db.collection('listings').add(listingData);
                alert('Listing created successfully!');
                document.getElementById('createListingForm').reset();
                showScreen('browse');
            } catch (error) {
                alert('Failed to create listing: ' + error.message);
            }
        });

        // Load listings
        async function loadListings() {
            try {
                const snapshot = await db.collection('listings')
                    .where('active', '==', true)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                listings = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                displayListings(listings);
            } catch (error) {
                console.error('Error loading listings:', error);
            }
        }

        // Display listings
        function displayListings(listingsToShow) {
            const grid = document.getElementById('listingsGrid');
            grid.innerHTML = '';

            listingsToShow.forEach(listing => {
                const listingCard = document.createElement('div');
                listingCard.className = 'bg-white rounded-lg shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition-shadow';
                listingCard.onclick = () => showListingModal(listing);

                const imageHtml = listing.images && listing.images.length > 0 
                    ? `<img src="${listing.images[0]}" alt="${listing.title}" class="w-full h-48 object-cover">`
                    : '<div class="w-full h-48 bg-gray-200 flex items-center justify-center text-gray-500">No Image</div>';

                listingCard.innerHTML = `
                    ${imageHtml}
                    <div class="p-4">
                        <h3 class="font-semibold text-lg mb-2">${listing.title}</h3>
                        <p class="text-gray-600 text-sm mb-2">${listing.description.substring(0, 100)}${listing.description.length > 100 ? '...' : ''}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-blue-600 font-bold">£${listing.price}</span>
                            <span class="text-sm text-gray-500">${formatLocation(listing.location)}</span>
                        </div>
                        <div class="mt-2">
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${formatCategory(listing.category)}</span>
                        </div>
                    </div>
                `;

                grid.appendChild(listingCard);
            });
        }

        // Format location for display
        function formatLocation(location) {
            const locationMap = {
                'brighton-city': 'Brighton City Center',
                'hove': 'Hove',
                'sussex-campus': 'Sussex Campus',
                'brighton-campus': 'Brighton Campus',
                'portslade': 'Portslade',
                'kemp-town': 'Kemp Town'
            };
            return locationMap[location] || location;
        }

        // Format category for display
        function formatCategory(category) {
            const categoryMap = {
                'sale': 'For Sale',
                'rent': 'For Rent',
                'service-offered': 'Service Offered',
                'service-wanted': 'Service Wanted'
            };
            return categoryMap[category] || category;
        }

        // Search and filter functionality
        document.getElementById('searchInput').addEventListener('input', filterListings);
        document.getElementById('categoryFilter').addEventListener('change', filterListings);
        document.getElementById('locationFilter').addEventListener('change', filterListings);

        function filterListings() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const locationFilter = document.getElementById('locationFilter').value;

            const filteredListings = listings.filter(listing => {
                const matchesSearch = listing.title.toLowerCase().includes(searchTerm) || 
                                    listing.description.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || listing.category === categoryFilter;
                const matchesLocation = !locationFilter || listing.location === locationFilter;
                
                return matchesSearch && matchesCategory && matchesLocation;
            });

            displayListings(filteredListings);
        }

        // Show listing modal
        async function showListingModal(listing) {
            const modal = document.getElementById('listingModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const contactBtn = document.getElementById('contactSellerBtn');
            const reportBtn = document.getElementById('reportListingBtn');

            modalTitle.textContent = listing.title;

            // Get seller info
            let sellerInfo = 'Unknown';
            try {
                const sellerDoc = await db.collection('users').doc(listing.userId).get();
                if (sellerDoc.exists) {
                    sellerInfo = sellerDoc.data().username;
                }
            } catch (error) {
                console.error('Error loading seller info:', error);
            }

            // Build modal content
            let imagesHtml = '';
            if (listing.images && listing.images.length > 0) {
                imagesHtml = listing.images.map(img => 
                    `<img src="${img}" alt="${listing.title}" class="w-full h-64 object-cover rounded-lg mb-4">`
                ).join('');
            }

            modalContent.innerHTML = `
                ${imagesHtml}
                <div class="mb-4">
                    <h4 class="font-semibold text-lg mb-2">Description</h4>
                    <p class="text-gray-700">${listing.description}</p>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <h4 class="font-semibold mb-1">Price</h4>
                        <p class="text-blue-600 font-bold text-xl">£${listing.price}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-1">Location</h4>
                        <p>${formatLocation(listing.location)}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <h4 class="font-semibold mb-1">Category</h4>
                        <p>${formatCategory(listing.category)}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-1">Seller</h4>
                        <p>${sellerInfo}</p>
                    </div>
                </div>
                ${buildCategorySpecificDisplay(listing)}
            `;

            // Handle contact seller button
            contactBtn.onclick = () => {
                if (!currentUser) {
                    alert('Please login to contact sellers');
                    return;
                }
                if (currentUser.uid === listing.userId) {
                    alert('You cannot contact yourself');
                    return;
                }
                startChat(listing);
                modal.classList.add('hidden');
            };

            // Handle report button
            reportBtn.onclick = () => {
                if (!currentUser) {
                    alert('Please login to report listings');
                    return;
                }
                showReportModal(listing);
            };

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Build category-specific display
        function buildCategorySpecificDisplay(listing) {
            let html = '';
            
            if (listing.category === 'sale' || listing.category === 'rent') {
                html += `
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">Additional Information</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="text-sm text-gray-600">Time Available:</span>
                                <p>${listing.timeAvailable || 'Not specified'}</p>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Delivery:</span>
                                <p>${listing.deliveryOptions || 'Not specified'}</p>
                            </div>
                        </div>
                `;
                
                if (listing.category === 'rent' && listing.rentDuration) {
                    html += `
                        <div class="mt-2">
                            <span class="text-sm text-gray-600">Rent Duration:</span>
                            <p>${listing.rentDuration}</p>
                        </div>
                    `;
                }
                
                html += '</div>';
            } else if (listing.category === 'service-offered' || listing.category === 'service-wanted') {
                html += `
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">Service Details</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="text-sm text-gray-600">${listing.category === 'service-offered' ? 'Available:' : 'Needed:'}</span>
                                <p>${listing.serviceTime || 'Not specified'}</p>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Estimated Time:</span>
                                <p>${listing.estimatedTime || 'Not specified'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }

        // Close modal
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('listingModal').classList.add('hidden');
            document.getElementById('listingModal').classList.remove('flex');
        });

        // Start chat
        async function startChat(listing) {
            try {
                // Check if chat already exists
                const existingChat = await db.collection('chats')
                    .where('listingId', '==', listing.id)
                    .where('participants', 'array-contains', currentUser.uid)
                    .get();

                let chatId;
                if (existingChat.empty) {
                    // Create new chat
                    const chatData = {
                        listingId: listing.id,
                        listingTitle: listing.title,
                        participants: [currentUser.uid, listing.userId],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastMessage: '',
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const chatRef = await db.collection('chats').add(chatData);
                    chatId = chatRef.id;
                    
                    // Send initial message
                    await db.collection('chats').doc(chatId).collection('messages').add({
                        senderId: currentUser.uid,
                        text: `Hi, I'm interested in your listing: ${listing.title}`,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        read: false
                    });
                } else {
                    chatId = existingChat.docs[0].id;
                }

                // Navigate to messages and open chat
                showScreen('messages');
                setTimeout(() => openChat(chatId), 500);
            } catch (error) {
                console.error('Error starting chat:', error);
                alert('Failed to start chat');
            }
        }

        // Load chats
        async function loadChats() {
            if (!currentUser) return;

            try {
                const snapshot = await db.collection('chats')
                    .where('participants', 'array-contains', currentUser.uid)
                    .orderBy('lastMessageTime', 'desc')
                    .get();

                chats = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                displayChats();
            } catch (error) {
                console.error('Error loading chats:', error);
            }
        }

        // Display chats
        async function displayChats() {
            const chatsList = document.getElementById('chatsList');
            chatsList.innerHTML = '';

            for (const chat of chats) {
                const otherUserId = chat.participants.find(id => id !== currentUser.uid);
                let otherUserName = 'Unknown';
                
                try {
                    const userDoc = await db.collection('users').doc(otherUserId).get();
                    if (userDoc.exists) {
                        otherUserName = userDoc.data().username;
                    }
                } catch (error) {
                    console.error('Error loading user info:', error);
                }

                const chatItem = document.createElement('div');
                chatItem.className = 'p-4 hover:bg-gray-50 cursor-pointer';
                chatItem.onclick = () => openChat(chat.id);

                chatItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold">${otherUserName}</h4>
                            <p class="text-sm text-gray-600">${chat.listingTitle}</p>
                            <p class="text-sm text-gray-500 mt-1">${chat.lastMessage || 'No messages yet'}</p>
                        </div>
                        <div class="text-xs text-gray-400">
                            ${chat.lastMessageTime ? new Date(chat.lastMessageTime.seconds * 1000).toLocaleDateString() : ''}
                        </div>
                    </div>
                `;

                chatsList.appendChild(chatItem);
            }
        }

        // Open chat
        async function openChat(chatId) {
            currentChatId = chatId;
            const chat = chats.find(c => c.id === chatId);
            
            if (!chat) return;

            // Update UI
            document.getElementById('chatWindow').classList.remove('hidden');
            document.getElementById('noChatSelected').classList.add('hidden');
            document.getElementById('chatTitle').textContent = chat.listingTitle;
            document.getElementById('chatListingInfo').textContent = `Chat about: ${chat.listingTitle}`;

            // Load messages
            loadMessages(chatId);
        }

        // Load messages
        function loadMessages(chatId) {
            const messagesContainer = document.getElementById('messagesContainer');
            
            // Listen for real-time updates
            db.collection('chats').doc(chatId).collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    messagesContainer.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `mb-4 ${message.senderId === currentUser.uid ? 'text-right' : 'text-left'}`;
                        
                        messageDiv.innerHTML = `
                            <div class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                                message.senderId === currentUser.uid 
                                    ? 'bg-blue-600 text-white' 
                                    : 'bg-gray-200 text-gray-800'
                            }">
                                <p>${message.text}</p>
                                <p class="text-xs mt-1 opacity-75">
                                    ${message.timestamp ? new Date(message.timestamp.seconds * 1000).toLocaleTimeString() : ''}
                                </p>
                            </div>
                        `;
                        
                        messagesContainer.appendChild(messageDiv);
                    });
                    
                    // Scroll to bottom
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
        }

        // Send message
        document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();
            
            if (!text || !currentChatId) return;

            try {
                await db.collection('chats').doc(currentChatId).collection('messages').add({
                    senderId: currentUser.uid,
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                });

                // Update chat's last message
                await db.collection('chats').doc(currentChatId).update({
                    lastMessage: text,
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                });

                messageInput.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message');
            }
        }

        // Load my listings
        async function loadMyListings() {
            if (!currentUser) return;

            try {
                const snapshot = await db.collection('listings')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();

                const myListings = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                displayMyListings(myListings);
            } catch (error) {
                console.error('Error loading my listings:', error);
            }
        }

        // Display my listings
        function displayMyListings(listings) {
            const container = document.getElementById('myListings');
            container.innerHTML = '';

            if (listings.length === 0) {
                container.innerHTML = '<p class="text-gray-500">You haven\'t created any listings yet.</p>';
                return;
            }

            listings.forEach(listing => {
                const listingDiv = document.createElement('div');
                listingDiv.className = 'bg-gray-50 p-4 rounded-lg';
                
                listingDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold">${listing.title}</h4>
                            <p class="text-sm text-gray-600 mt-1">${listing.description.substring(0, 100)}...</p>
                            <div class="flex items-center space-x-4 mt-2">
                                <span class="text-blue-600 font-bold">£${listing.price}</span>
                                <span class="text-sm text-gray-500">${formatCategory(listing.category)}</span>
                                <span class="text-sm text-gray-500">${formatLocation(listing.location)}</span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editListing('${listing.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                            <button onclick="deleteListing('${listing.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                        </div>
                    </div>
                `;
                
                container.appendChild(listingDiv);
            });
        }

        // Delete listing
        window.deleteListing = async function(listingId) {
            if (!confirm('Are you sure you want to delete this listing?')) return;

            try {
                await db.collection('listings').doc(listingId).delete();
                alert('Listing deleted successfully');
                loadMyListings();
            } catch (error) {
                console.error('Error deleting listing:', error);
                alert('Failed to delete listing');
            }
        };

        // Edit listing (simplified - just toggle active status)
        window.editListing = async function(listingId) {
            try {
                const doc = await db.collection('listings').doc(listingId).get();
                const listing = doc.data();
                
                await db.collection('listings').doc(listingId).update({
                    active: !listing.active
                });
                
                alert(`Listing ${listing.active ? 'deactivated' : 'activated'} successfully`);
                loadMyListings();
            } catch (error) {
                console.error('Error editing listing:', error);
                alert('Failed to edit listing');
            }
        };

        // Report modal
        function showReportModal(listing) {
            const modal = document.getElementById('reportModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            document.getElementById('reportForm').onsubmit = async (e) => {
                e.preventDefault();
                
                const reportData = {
                    reporterId: currentUser.uid,
                    listingId: listing.id,
                    reason: document.getElementById('reportReason').value,
                    description: document.getElementById('reportDescription').value,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    // Handle screenshot upload if provided
                    const screenshot = document.getElementById('reportScreenshot').files[0];
                    if (screenshot) {
                        const screenshotRef = storage.ref(`reports/${currentUser.uid}/${Date.now()}_${screenshot.name}`);
                        const snapshot = await screenshotRef.put(screenshot);
                        reportData.screenshotUrl = await snapshot.ref.getDownloadURL();
                    }

                    await db.collection('reports').add(reportData);
                    alert('Report submitted successfully');
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    document.getElementById('reportForm').reset();
                } catch (error) {
                    console.error('Error submitting report:', error);
                    alert('Failed to submit report');
                }
            };
        }

        // Close report modal
        document.getElementById('cancelReport').addEventListener('click', () => {
            document.getElementById('reportModal').classList.add('hidden');
            document.getElementById('reportModal').classList.remove('flex');
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Show browse screen by default for unauthenticated users
            showScreen('browse');
            loadListings();
        });
    </script>
</body>
</html>